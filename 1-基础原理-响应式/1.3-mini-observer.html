<script>
    class Dep {
        constructor() {
            this.list = new Set()

        }

        depend() {
            if (Dep.target) {
                this.list.add(Dep.target)
            }
        }

        notify() {
            this.list.forEach(sub => sub())
        }
    }
    Dep.target = null

    var observe = function (obj) {
        var keys = Object.keys(obj)
        for (var i = 0; i < keys.length; i++) {
            var key = keys[i]
            var cache = obj[key]
            var dep = new Dep()
            Object.defineProperty(obj, key, {
                get() {
                    dep.depend()
                    return cache
                },
                set(value) {
                    var changed = cache !== value
                    if (changed) {
                        cache = value
                        dep.notify()
                    }
                }
            })
        }
        return obj
    }

    var autorun = function (update) {
        var target = () => {
            Dep.target = target
            update()
            Dep.target = null
        }
        target()
    }

    // 这里我把 Dep 暴露给 window 方便测试
    window.Dep = Dep
</script>